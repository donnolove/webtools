<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”å½±ç„¦æ®µåˆ†æå„€ (V5.0 - Tab åˆ†é ä»‹é¢)</title>
    <!-- å¼•å…¥ EXIF è®€å–åº« -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js" onerror="handleScriptError()"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #181818;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin-bottom: 10px; color: #fff; }
        p { color: #888; margin-bottom: 30px; text-align: center; }

        /* æ‹–æ›³å€åŸŸ */
        #drop-zone {
            width: 80%;
            max-width: 800px;
            height: 150px;
            border: 2px dashed #444;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #252526;
            transition: 0.3s;
            cursor: pointer;
        }
        
        #drop-zone.dragover {
            border-color: #007acc;
            background-color: #2d2d30;
            transform: scale(1.02);
        }

        #drop-zone.error { border-color: #d9534f; background-color: #3e2020; }

        #drop-zone h3 { margin: 0; color: #aaa; }
        #drop-zone span { font-size: 12px; color: #666; margin-top: 5px; }

        /* é€²åº¦æ¢èˆ‡ç‹€æ…‹ */
        #status {
            margin-top: 20px;
            font-size: 16px;
            color: #007acc;
            min-height: 24px;
            font-weight: bold;
        }
        
        /* éŒ¯èª¤è¨Šæ¯å€ */
        #error-log {
            width: 80%;
            max-width: 800px;
            color: #d9534f;
            font-size: 12px;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* çµ±è¨ˆçµæœå®¹å™¨ */
        .results-container {
            width: 100%;
            max-width: 800px;
            margin-top: 30px;
            display: none;
        }

        /* Tab å°èˆªåˆ— */
        .tabs {
            display: flex;
            flex-wrap: wrap; /* è®“ Tab åœ¨å°è¢å¹•ä¸Šæ›è¡Œ */
            justify-content: flex-start;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            color: #888;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            white-space: nowrap; /* é˜²æ­¢ Tab åç¨±æ›è¡Œ */
        }

        .tab-button:hover:not(.active) {
            color: #fff;
            background-color: #2d2d30;
        }

        .tab-button.active {
            color: #007acc;
            border-bottom: 3px solid #007acc;
            background-color: #2d2d30;
        }

        /* Tab å…§å®¹å€ */
        .tab-content {
            display: none; /* é è¨­éš±è—æ‰€æœ‰å…§å®¹ */
            padding: 20px 0;
            background: #252526;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .tab-content.active {
            display: block; /* é¡¯ç¤ºé¸ä¸­çš„å…§å®¹ */
        }
        
        /* åˆ†å€æ¨™é¡Œ */
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin: 0 20px 15px 20px;
            border-bottom: 2px solid #444;
            padding-bottom: 5px;
        }

        /* é•·æ¢åœ–æ¨£å¼ */
        .chart-row {
            display: flex;
            align-items: center;
            margin: 0 20px 10px 20px;
            font-size: 14px;
        }

        .label {
            width: 140px; 
            text-align: right;
            padding-right: 10px;
            font-weight: bold;
            color: #ccc;
        }

        .bar-container {
            flex: 1;
            background-color: #333;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar {
            height: 100%;
            background: linear-gradient(90deg, #007acc, #00b4cc);
            width: 0%;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
        }
        
        /* ç‚ºæ¯å€‹ç¶­åº¦åˆ†é…ä¸åŒçš„é…è‰² */
        .focal-bar { background: linear-gradient(90deg, #007acc, #00b4cc); }
        .aperture-bar { background: linear-gradient(90deg, #ff9900, #ffcc66); } 
        .shutter-bar { background: linear-gradient(90deg, #28a745, #5cb85c); } 
        .iso-bar { background: linear-gradient(90deg, #9f3e9f, #cc66cc); } 
        .camera-bar { background: linear-gradient(90deg, #17a2b8, #58c7da); } 
        .flash-bar { background: linear-gradient(90deg, #f0ad4e, #f8d7a3); } 
        .wb-bar { background: linear-gradient(90deg, #66d9ef, #a6e22e); } 
        .metering-bar { background: linear-gradient(90deg, #f92672, #ff5988); } 

        /* è¨ˆæ•¸é¡¯ç¤ºåœ¨é•·æ¢åœ–å³å´ */
        .count-display {
            width: 40px;
            text-align: left;
            padding-left: 10px;
            font-weight: bold;
            color: #00b4cc;
            font-size: 14px;
        }

        /* ç¸½çµæ•¸æ“šå¡ç‰‡ */
        .summary-card {
            background: #2d2d30;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border-left: 4px solid #007acc;
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; }
        .stat-desc { font-size: 10px; color: #888; }

    </style>
</head>
<body>

    <h1>ğŸ“¸ æ”å½±åƒæ•¸çµ±è¨ˆåˆ†æ (V5.0)</h1>
    <p>å¦‚æœæ‹–æ›³è³‡æ–™å¤¾ç„¡æ•ˆï¼Œé€™æ˜¯å› ç‚ºç€è¦½å™¨å®‰å…¨é™åˆ¶ã€‚è«‹å‹™å¿…**é»æ“Šä¸‹æ–¹çš„æ¡†æ¡†**ï¼Œé¸æ“‡ **ã€Œè³‡æ–™å¤¾ã€** é€²è¡ŒåŒ¯å…¥ã€‚</p>

    <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
        <h3>ğŸ“‚ æ‹–æ›³ç…§ç‰‡ æˆ– é»æ“Šé¸æ“‡è³‡æ–™å¤¾ (æœ€å¯é )</h3>
        <span id="drop-hint">æ”¯æ´ JPG / JPEG æ ¼å¼</span>
        <input type="file" id="fileInput" multiple webkitdirectory directory style="display:none">
    </div>

    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="error-log"></div>

    <div class="results-container" id="results">
        <!-- ç¸½çµæ•¸æ“šå¡ç‰‡ -->
        <div class="summary-card">
            <!-- ç¸½è¨ˆ & æ›å…‰éµä¸‰è§’ (4 æ¬„) -->
            <div class="stat-item">
                <div class="stat-val" id="total-photos">0</div>
                <div class="stat-desc">æˆåŠŸè®€å–</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-focal">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„ç„¦æ®µ</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-aperture">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„å…‰åœˆ</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-shutter">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„å¿«é–€</div>
            </div>
            
            <!-- å…¶å®ƒé€²éšåƒæ•¸ (4 æ¬„) -->
            <div class="stat-item">
                <div class="stat-val" id="top-iso">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„ ISO</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-camera">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„æ©Ÿå‹</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-flash">--</div>
                <div class="stat-desc">é–ƒå…‰ç‡ˆä½¿ç”¨</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="top-wb">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„ç™½å¹³è¡¡</div>
            </div>
            
            <!-- å‰©ä¸‹ä¸€å€‹ (1 æ¬„) -->
            <div class="stat-item">
                <div class="stat-val" id="top-metering">--</div>
                <div class="stat-desc">æœ€æ„›ç”¨çš„æ¸¬å…‰æ¨¡å¼</div>
            </div>
        </div>
        
        <!-- Tab å°èˆªåˆ— -->
        <div class="tabs" id="tab-navigation">
            <button class="tab-button active" onclick="showTab('focal')">ğŸ”­ ç„¦æ®µ</button>
            <button class="tab-button" onclick="showTab('aperture')">ğŸ’§ å…‰åœˆ</button>
            <button class="tab-button" onclick="showTab('shutter')">ğŸ’¨ å¿«é–€</button>
            <button class="tab-button" onclick="showTab('iso')">ğŸ’¡ ISO</button>
            <button class="tab-button" onclick="showTab('camera')">ğŸ“· æ©Ÿå‹</button>
            <button class="tab-button" onclick="showTab('flash')">âš¡ é–ƒå…‰ç‡ˆ</button>
            <button class="tab-button" onclick="showTab('wb')">â˜€ï¸ ç™½å¹³è¡¡</button>
            <button class="tab-button" onclick="showTab('metering')">ğŸ¯ æ¸¬å…‰</button>
        </div>

        <!-- Tab å…§å®¹å€åŸŸ -->
        <div id="tab-content-container">
            <!-- ç„¦æ®µçµ±è¨ˆå€ -->
            <div id="focal-tab" class="tab-content active">
                <div class="chart-title">ğŸ”­ ç„¦æ®µä½¿ç”¨é »ç‡ (Focal Length)</div>
                <div id="focal-chart-area"></div>
            </div>
            
            <!-- å…‰åœˆçµ±è¨ˆå€ -->
            <div id="aperture-tab" class="tab-content">
                <div class="chart-title">ğŸ’§ å…‰åœˆä½¿ç”¨é »ç‡ (Aperture / F-stop)</div>
                <div id="aperture-chart-area"></div>
            </div>

            <!-- å¿«é–€é€Ÿåº¦çµ±è¨ˆå€ -->
            <div id="shutter-tab" class="tab-content">
                <div class="chart-title">ğŸ’¨ å¿«é–€é€Ÿåº¦ä½¿ç”¨é »ç‡ (Shutter Speed)</div>
                <div id="shutter-chart-area"></div>
            </div>
            
            <!-- ISO æ„Ÿå…‰åº¦çµ±è¨ˆå€ -->
            <div id="iso-tab" class="tab-content">
                <div class="chart-title">ğŸ’¡ ISO æ„Ÿå…‰åº¦ä½¿ç”¨é »ç‡ (ISO)</div>
                <div id="iso-chart-area"></div>
            </div>
            
            <!-- ç›¸æ©Ÿæ©Ÿå‹çµ±è¨ˆå€ -->
            <div id="camera-tab" class="tab-content">
                <div class="chart-title">ğŸ“· ç›¸æ©Ÿæ©Ÿå‹ä½¿ç”¨é »ç‡ (Camera Model)</div>
                <div id="camera-chart-area"></div>
            </div>
            
            <!-- é–ƒå…‰ç‡ˆä½¿ç”¨çµ±è¨ˆå€ -->
            <div id="flash-tab" class="tab-content">
                <div class="chart-title">âš¡ é–ƒå…‰ç‡ˆä½¿ç”¨é »ç‡ (Flash Usage)</div>
                <div id="flash-chart-area"></div>
            </div>

            <!-- ç™½å¹³è¡¡çµ±è¨ˆå€ -->
            <div id="wb-tab" class="tab-content">
                <div class="chart-title">â˜€ï¸ ç™½å¹³è¡¡ä½¿ç”¨é »ç‡ (White Balance)</div>
                <div id="wb-chart-area"></div>
            </div>
            
            <!-- æ¸¬å…‰æ¨¡å¼çµ±è¨ˆå€ -->
            <div id="metering-tab" class="tab-content">
                <div class="chart-title">ğŸ¯ æ¸¬å…‰æ¨¡å¼ä½¿ç”¨é »ç‡ (Metering Mode)</div>
                <div id="metering-chart-area"></div>
            </div>

        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const statusDiv = document.getElementById('status');
        const errorLog = document.getElementById('error-log');
        const resultsDiv = document.getElementById('results');
        const fileInput = document.getElementById('fileInput');

        // Chart Area IDs
        const chartAreas = {
            focal: document.getElementById('focal-chart-area'),
            aperture: document.getElementById('aperture-chart-area'),
            shutter: document.getElementById('shutter-chart-area'),
            iso: document.getElementById('iso-chart-area'),
            camera: document.getElementById('camera-chart-area'),
            flash: document.getElementById('flash-chart-area'),
            wb: document.getElementById('wb-chart-area'),
            metering: document.getElementById('metering-chart-area')
        };
        
        // Tab Content IDs
        const tabContents = {
            focal: document.getElementById('focal-tab'),
            aperture: document.getElementById('aperture-tab'),
            shutter: document.getElementById('shutter-tab'),
            iso: document.getElementById('iso-tab'),
            camera: document.getElementById('camera-tab'),
            flash: document.getElementById('flash-tab'),
            wb: document.getElementById('wb-tab'),
            metering: document.getElementById('metering-tab')
        };

        let focalStats = {};
        let apertureStats = {};
        let shutterStats = {};
        let isoStats = {};
        let cameraStats = {};     
        let flashStats = {};      
        let wbStats = {};         
        let meteringStats = {};   
        let validPhotos = 0;
        let isLibraryLoaded = false;

        // --- Tab åˆ‡æ›é‚è¼¯ (NEW) ---
        window.showTab = function(tabId) {
            // éš±è—æ‰€æœ‰ Tab å…§å®¹
            Object.values(tabContents).forEach(content => content.classList.remove('active'));
            // é¡¯ç¤ºé¸å®šçš„ Tab å…§å®¹
            tabContents[tabId].classList.add('active');

            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            // ç‚ºé¸å®šçš„æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            document.querySelector(`.tab-button[onclick*='${tabId}']`).classList.add('active');
        }

        // æª¢æŸ¥ EXIF åº«æ˜¯å¦è¼‰å…¥
        window.onload = function() {
            if (typeof EXIF !== 'undefined') {
                isLibraryLoaded = true;
                statusDiv.innerText = "âœ… ç³»çµ±æº–å‚™å°±ç·’ï¼Œè«‹æ‹–å…¥æˆ–é»æ“ŠåŒ¯å…¥è³‡æ–™å¤¾";
            } else {
                handleScriptError();
            }
        };

        function handleScriptError() {
            statusDiv.innerText = "âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ EXIF åˆ†æå·¥å…·";
            statusDiv.style.color = "#d9534f";
            dropZone.classList.add('error');
            document.getElementById('drop-hint').innerText = "è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–å˜—è©¦é‡æ–°æ•´ç†ç¶²é ã€‚";
        }

        // --- EXIF æ•¸å€¼è½‰æ›å‡½æ•¸ (æœªä¿®æ”¹) ---
        function getWhiteBalanceString(value) {
            switch (Number(value)) {
                case 0: return "è‡ªå‹•ç™½å¹³è¡¡ (Auto)";
                case 1: return "æ‰‹å‹•/è‡ªè¨‚ (Manual)";
                case 2: return "æ—¥å…‰ (Daylight)";
                case 3: return "é™°å¤© (Cloudy)";
                case 4: return "é¢çµ²ç‡ˆ (Tungsten)";
                case 5: return "è¢å…‰ç‡ˆ (Fluorescent)";
                case 6: return "é–ƒå…‰ç‡ˆ (Flash)";
                default: return `é è¨­å€¼ ${value} / æœªçŸ¥`; 
            }
        }

        function getMeteringModeString(value) {
            switch (Number(value)) {
                case 1: return "å¹³å‡æ¸¬å…‰ (Average)";
                case 2: return "ä¸­å¤®é‡é» (Center-Weighted)";
                case 3: return "é»æ¸¬å…‰ (Spot)";
                case 4: return "å¤šå€/çŸ©é™£ (Multi-Segment)";
                case 5: return "å±€éƒ¨æ¸¬å…‰ (Partial)";
                case 6: return "å…¶ä»– (Other)";
                case 0: // Fall-through
                default: return "æœªçŸ¥/é è¨­ (Unknown)"; 
            }
        }

        // --- æ‹–æ›³/é¸æ“‡æª”æ¡ˆäº‹ä»¶è™•ç† (æœªä¿®æ”¹) ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            if (!isLibraryLoaded) { 
                statusDiv.innerText = "âŒ éŒ¯èª¤ï¼šåˆ†æå·¥å…·å°šæœªè¼‰å…¥ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–é‡æ–°æ•´ç†ã€‚";
                statusDiv.style.color = "#d9534f";
                return; 
            }

            resetData();
            statusDiv.innerText = "â³ æ­£åœ¨æƒææª”æ¡ˆ...";
            
            let files = [];
            
            // å„ªå…ˆè™•ç†ç°¡å–®çš„æª”æ¡ˆæ‹–æ›³
            if (e.dataTransfer.files.length > 0) {
                files = Array.from(e.dataTransfer.files).filter(file => file.name.toLowerCase().match(/\.(jpe?g)$/));
            }

            // å˜—è©¦è™•ç†è³‡æ–™å¤¾æ‹–æ›³
            if (files.length === 0 && e.dataTransfer.items) {
                const items = e.dataTransfer.items;
                try {
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                        if (item) {
                            await traverseFileTree(item, files);
                        }
                    }
                } catch (err) {
                    logError("æ‹–æ›³ç›®éŒ„çµæ§‹è§£æå¤±æ•—ï¼Œå¯èƒ½æ¬Šé™ä¸è¶³ã€‚");
                    console.error("Folder scan failed:", err);
                }
            }

            if (files.length === 0) {
                statusDiv.innerText = "âŒ æ‰¾ä¸åˆ° JPG æª”æ¡ˆã€‚è«‹ç¢ºèªè³‡æ–™å¤¾å…§æœ‰ .jpg, .jpeg æˆ– .jpe åœ–ç‰‡ã€‚";
                logError("âŒ åš´é‡é™åˆ¶ï¼šç€è¦½å™¨æœªèƒ½æˆåŠŸè®€å–è³‡æ–™å¤¾å…§å®¹ã€‚è«‹æ”¹ç”¨ã€Œé»æ“Šé¸æ“‡ã€å¾Œï¼Œä¸€æ¬¡é¸å–æ‰€æœ‰å–®å¼µç…§ç‰‡ã€‚");
                return;
            }

            processFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if (!isLibraryLoaded) return;
            if (e.target.files.length > 0) {
                resetData();
                const totalReceived = e.target.files.length;
                
                statusDiv.innerText = `ğŸ” æƒæåˆ° ${totalReceived} å€‹æª”æ¡ˆ... æ­£åœ¨éæ¿¾ JPG/JPEG/JPE`;

                const files = Array.from(e.target.files).filter(file => file.name.toLowerCase().match(/\.(jpe?g)$/));

                if (files.length === 0) {
                    statusDiv.innerText = "âŒ æ‰¾ä¸åˆ° JPG æª”æ¡ˆã€‚è«‹ç¢ºèªè³‡æ–™å¤¾å…§æœ‰ .jpg, .jpeg æˆ– .jpe åœ–ç‰‡ã€‚";
                    logError("âŒ åš´é‡é™åˆ¶ï¼šç€è¦½å™¨è¿”å›çš„æª”æ¡ˆåˆ—è¡¨ç‚ºç©º (0 å€‹æª”æ¡ˆ)ã€‚è«‹æ”¹ç”¨ã€Œé»æ“Šé¸æ“‡ã€å¾Œï¼Œä¸€æ¬¡é¸å–æ‰€æœ‰å–®å¼µç…§ç‰‡ã€‚");
                    return;
                }

                processFiles(files);
            } else {
                resetData();
                statusDiv.innerText = "âŒ æ‰¾ä¸åˆ° JPG æª”æ¡ˆã€‚è«‹ç¢ºèªè³‡æ–™å¤¾å…§æœ‰ .jpg, .jpeg æˆ– .jpe åœ–ç‰‡ã€‚";
                logError("âŒ åš´é‡é™åˆ¶ï¼šç€è¦½å™¨è¿”å›çš„æª”æ¡ˆåˆ—è¡¨ç‚ºç©º (0 å€‹æª”æ¡ˆ)ã€‚è«‹æ”¹ç”¨ã€Œé»æ“Šé¸æ“‡ã€å¾Œï¼Œä¸€æ¬¡é¸å–æ‰€æœ‰å–®å¼µç…§ç‰‡ã€‚");
            }
        });

        // --- è³‡æ–™å¤¾éè¿´é‚è¼¯ (æœªä¿®æ”¹) ---
        function traverseFileTree(item, fileList) {
            return new Promise((resolve) => {
                if (item.isFile) {
                    item.file((file) => {
                        if (file.name.toLowerCase().match(/\.(jpe?g)$/)) {
                            fileList.push(file);
                        }
                        resolve();
                    }, (err) => resolve());
                } else if (item.isDirectory) {
                    const dirReader = item.createReader();
                    const readEntries = () => {
                        dirReader.readEntries(async (entries) => {
                            if (entries.length > 0) {
                                for (let i = 0; i < entries.length; i++) {
                                    await traverseFileTree(entries[i], fileList);
                                }
                                readEntries(); 
                            } else {
                                resolve();
                            }
                        }, (err) => resolve()); 
                    };
                    readEntries();
                } else {
                    resolve();
                }
            });
        }

        // --- EXIF åˆ†æ (æœªä¿®æ”¹) ---
        async function processFiles(files) {
            statusDiv.innerText = `ğŸ” æº–å‚™åˆ†æ ${files.length} å¼µç…§ç‰‡...`;
            
            for (let i = 0; i < files.length; i++) {
                await readExifSafe(files[i]);
                if (i % 20 === 0 || i === files.length - 1) {
                    statusDiv.innerText = `ğŸ”„ åˆ†æé€²åº¦: ${i + 1} / ${files.length}`;
                }
            }

            statusDiv.innerText = "âœ… åˆ†æå®Œæˆï¼";
            statusDiv.style.color = "#28a745";
            renderCharts();
        }

        // å®‰å…¨è®€å– EXIF (å«è¶…æ™‚æ©Ÿåˆ¶)
        function readExifSafe(file) {
            return new Promise((resolve) => {
                let isResolved = false;

                const timeout = setTimeout(() => {
                    if (!isResolved) {
                        isResolved = true;
                        resolve(); 
                    }
                }, 1000);

                try {
                    EXIF.getData(file, function() {
                        if (isResolved) return; 
                        
                        let hasData = false;

                        // 1. ç„¦æ®µ (Focal Length)
                        const focalLen = EXIF.getTag(this, "FocalLength");
                        if (focalLen) {
                            const val = Math.round(Number(focalLen));
                            const key = val + "mm";
                            focalStats[key] = (focalStats[key] || 0) + 1;
                            hasData = true;
                        }

                        // 2. å…‰åœˆ (FNumber)
                        const fNumber = EXIF.getTag(this, "FNumber");
                        if (fNumber) {
                            const aperture = Number(fNumber);
                            const key = "f/" + aperture.toFixed(1);
                            apertureStats[key] = (apertureStats[key] || 0) + 1;
                            hasData = true;
                        }
                        
                        // 3. å¿«é–€é€Ÿåº¦ (ExposureTime)
                        const expTime = EXIF.getTag(this, "ExposureTime");
                        if (expTime) {
                            let key;
                            const expVal = Number(expTime);
                            
                            if (expVal < 1) {
                                const denominator = Math.round(1 / expVal);
                                key = `1/${denominator}s`;
                            } else {
                                key = `${expVal.toFixed(1)}s`;
                            }
                            shutterStats[key] = (shutterStats[key] || 0) + 1;
                            hasData = true;
                        }

                        // 4. ISO (ISOSpeedRatings)
                        const iso = EXIF.getTag(this, "ISOSpeedRatings");
                        if (iso) {
                            const key = `ISO ${iso}`;
                            isoStats[key] = (isoStats[key] || 0) + 1;
                            hasData = true;
                        }
                        
                        // 5. ç›¸æ©Ÿæ©Ÿå‹ (Model)
                        const model = EXIF.getTag(this, "Model");
                        if (model) {
                            const key = model.trim();
                            cameraStats[key] = (cameraStats[key] || 0) + 1;
                            hasData = true;
                        }

                        // 6. é–ƒå…‰ç‡ˆä½¿ç”¨ (Flash)
                        const flash = EXIF.getTag(this, "Flash");
                        if (flash !== undefined) {
                            let key;
                            if (flash & 1) { 
                                key = "é–ƒå…‰ç‡ˆé–‹å•Ÿ (Fired)";
                            } else {
                                key = "ç„¡é–ƒå…‰ç‡ˆ (No Flash)";
                            }
                            flashStats[key] = (flashStats[key] || 0) + 1;
                            hasData = true;
                        }
                        
                        // 7. ç™½å¹³è¡¡ (WhiteBalance)
                        const wb = EXIF.getTag(this, "WhiteBalance");
                        if (wb !== undefined) {
                            const key = getWhiteBalanceString(wb);
                            wbStats[key] = (wbStats[key] || 0) + 1;
                            hasData = true;
                        }
                        
                        // 8. æ¸¬å…‰æ¨¡å¼ (MeteringMode)
                        const metering = EXIF.getTag(this, "MeteringMode");
                        if (metering !== undefined) {
                            const key = getMeteringModeString(metering);
                            meteringStats[key] = (meteringStats[key] || 0) + 1;
                            hasData = true;
                        }


                        if (hasData) {
                            validPhotos++;
                        }
                        
                        clearTimeout(timeout);
                        isResolved = true;
                        resolve();
                    });
                } catch (e) {
                    clearTimeout(timeout);
                    if (!isResolved) {
                        isResolved = true;
                        resolve();
                    }
                }
            });
        }

        function resetData() {
            focalStats = {};
            apertureStats = {};
            shutterStats = {}; 
            isoStats = {};     
            cameraStats = {};    
            flashStats = {};     
            wbStats = {};         
            meteringStats = {};   
            validPhotos = 0;
            resultsDiv.style.display = 'none';
            Object.values(chartAreas).forEach(area => area.innerHTML = ''); // æ¸…ç©ºæ‰€æœ‰åœ–è¡¨å€
            errorLog.innerHTML = '';
            statusDiv.style.color = "#007acc";
        }

        function logError(msg) {
            errorLog.innerHTML += `<div>${msg}</div>`;
        }

        // --- ç¹ªè£½åœ–è¡¨ (å·²æ›´æ–°ï¼šç¹ªè£½å¾Œé è¨­é¡¯ç¤ºç¬¬ä¸€å€‹ Tab) ---
        function renderCharts() {
            if (validPhotos === 0) {
                statusDiv.innerText = "âš ï¸ åˆ†æå®Œæˆï¼Œä½†æœªè®€å–åˆ°ä»»ä½• EXIF è³‡è¨Š";
                return;
            }

            resultsDiv.style.display = 'block';
            document.getElementById('total-photos').innerText = validPhotos;

            // 1. ç„¦æ®µ (Focal)
            const sortedFocalStats = Object.entries(focalStats).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            let maxFocalCount = 0;
            let topFocal = "N/A";
            sortedFocalStats.forEach(([f, c]) => { if (c > maxFocalCount) { maxFocalCount = c; topFocal = f; } });
            document.getElementById('top-focal').innerText = topFocal;
            
            // 2. å…‰åœˆ (Aperture)
            const sortedApertureStats = Object.entries(apertureStats).sort((a, b) => parseFloat(a[0].substring(2)) - parseFloat(b[0].substring(2)));
            let maxApertureCount = 0;
            let topAperture = "N/A";
            sortedApertureStats.forEach(([f, c]) => { if (c > maxApertureCount) { maxApertureCount = c; topAperture = f; } });
            document.getElementById('top-aperture').innerText = topAperture;

            // 3. å¿«é–€ (Shutter)
            const sortedShutterStats = Object.entries(shutterStats).sort((a, b) => {
                const valA = a[0].startsWith('1/') ? 1 / parseFloat(a[0].substring(2, a[0].length - 1)) : parseFloat(a[0]);
                const valB = b[0].startsWith('1/') ? 1 / parseFloat(b[0].substring(2, b[0].length - 1)) : parseFloat(b[0]);
                return valA - valB;
            });
            let maxShutterCount = 0;
            let topShutter = "N/A";
            sortedShutterStats.forEach(([f, c]) => { if (c > maxShutterCount) { maxShutterCount = c; topShutter = f; } });
            document.getElementById('top-shutter').innerText = topShutter;
            
            // 4. ISO
            const sortedISOStats = Object.entries(isoStats).sort((a, b) => parseInt(a[0].substring(4)) - parseInt(b[0].substring(4)));
            let maxISOCount = 0;
            let topISO = "N/A";
            sortedISOStats.forEach(([f, c]) => { if (c > maxISOCount) { maxISOCount = c; topISO = f; } });
            document.getElementById('top-iso').innerText = topISO;
            
            // 5. ç›¸æ©Ÿæ©Ÿå‹ (Camera)
            const sortedCameraStats = Object.entries(cameraStats).sort((a, b) => b[1] - a[1]); 
            let maxCameraCount = 0;
            let topCamera = "N/A";
            sortedCameraStats.forEach(([f, c]) => { if (c > maxCameraCount) { maxCameraCount = c; topCamera = f; } });
            document.getElementById('top-camera').innerText = topCamera;
            
            // 6. é–ƒå…‰ç‡ˆ (Flash)
            const sortedFlashStats = Object.entries(flashStats).sort((a, b) => b[1] - a[1]); 
            let maxFlashCount = 0;
            let topFlash = "N/A";
            sortedFlashStats.forEach(([f, c]) => { if (c > maxFlashCount) { maxFlashCount = c; topFlash = f; } });
            document.getElementById('top-flash').innerText = topFlash;

            // 7. ç™½å¹³è¡¡ (White Balance)
            const sortedWBStats = Object.entries(wbStats).sort((a, b) => b[1] - a[1]);
            let maxWBCount = 0;
            let topWB = "N/A";
            sortedWBStats.forEach(([f, c]) => { if (c > maxWBCount) { maxWBCount = c; topWB = f; } });
            document.getElementById('top-wb').innerText = topWB;

            // 8. æ¸¬å…‰æ¨¡å¼ (Metering Mode)
            const sortedMeteringStats = Object.entries(meteringStats).sort((a, b) => b[1] - a[1]);
            let maxMeteringCount = 0;
            let topMetering = "N/A";
            sortedMeteringStats.forEach(([f, c]) => { if (c > maxMeteringCount) { maxMeteringCount = c; topMetering = f; } });
            document.getElementById('top-metering').innerText = topMetering;


            // ç¹ªè£½åœ–è¡¨
            renderChart(sortedFocalStats, chartAreas.focal, maxFocalCount, 'focal-bar');
            renderChart(sortedApertureStats, chartAreas.aperture, maxApertureCount, 'aperture-bar');
            renderChart(sortedShutterStats, chartAreas.shutter, maxShutterCount, 'shutter-bar');
            renderChart(sortedISOStats, chartAreas.iso, maxISOCount, 'iso-bar');
            renderChart(sortedCameraStats, chartAreas.camera, maxCameraCount, 'camera-bar');
            renderChart(sortedFlashStats, chartAreas.flash, maxFlashCount, 'flash-bar');
            renderChart(sortedWBStats, chartAreas.wb, maxWBCount, 'wb-bar');
            renderChart(sortedMeteringStats, chartAreas.metering, maxMeteringCount, 'metering-bar');
            
            // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹ Tab (ç„¦æ®µ)
            showTab('focal');
        }

        function renderChart(sortedStats, chartArea, maxCount, barClass) {
            chartArea.innerHTML = '';
            
            if (sortedStats.length === 0) {
                chartArea.innerHTML = '<p style="color:#888; text-align: center; padding: 0 20px;">æœªåµæ¸¬åˆ°æ­¤é¡å‹çš„ EXIF è³‡è¨Šã€‚</p>';
                return;
            }
            
            sortedStats.forEach(([label, count]) => {
                const percentage = (count / maxCount) * 100; 
                const row = document.createElement('div');
                row.className = 'chart-row';
                
                let color;
                // æ ¹æ“š barClass è¨­ç½®é¡è‰²ä»¥åŒ¹é…é•·æ¢åœ–çš„æ¼¸å±¤
                switch(barClass) {
                    case 'focal-bar': color = '#00b4cc'; break;
                    case 'aperture-bar': color = '#ff9900'; break;
                    case 'shutter-bar': color = '#28a745'; break;
                    case 'iso-bar': color = '#9f3e9f'; break;
                    case 'camera-bar': color = '#17a2b8'; break;
                    case 'flash-bar': color = '#f0ad4e'; break;
                    case 'wb-bar': color = '#66d9ef'; break;
                    case 'metering-bar': color = '#f92672'; break;
                    default: color = '#00b4cc'; break;
                }
                
                row.innerHTML = `
                    <div class="label">${label}</div>
                    <div class="bar-container">
                        <div class="bar ${barClass}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="count-display" style="color: ${color}">${count}</div>
                `;
                chartArea.appendChild(row);
            });
        }
    </script>
</body>
</html>